# Claude Progress - Job Tracker

## Session: 2026-01-02 (Stripe Integration)

### Completed: Full Stripe Payment Integration

Implemented complete Stripe integration for subscription billing and one-time payments.

**Files Created:**

1. **Stripe Client** (`lib/stripe.ts`)
   - Initialize Stripe with secret key (API version 2025-12-15.clover)
   - Helper functions: getOrCreateCustomer, createCheckoutSession, createBillingPortalSession
   - Subscription management: getSubscription, cancelSubscription
   - Webhook signature verification: constructWebhookEvent

2. **Price Constants** (`lib/stripe-prices.ts`)
   - Price ID constants from environment variables
   - Plan metadata with features and limits
   - Tier types: free, pro, power
   - Helper functions: getTierFromPriceId, getCvLimitForTier, hasReachedCvLimit, getPaymentMode
   - Job Search Pass one-time payment config

3. **Checkout API** (`app/api/stripe/create-checkout/route.ts`)
   - POST endpoint for creating checkout sessions
   - Input: `{ priceId, successUrl?, cancelUrl? }`
   - Validates priceId against allowed prices
   - Creates/retrieves Stripe customer
   - Supports both subscription and one-time payment modes
   - Returns checkout URL and session ID

4. **Webhook Handler** (`app/api/stripe/webhooks/route.ts`)
   - POST endpoint receiving raw body
   - Signature verification with STRIPE_WEBHOOK_SECRET
   - Events handled:
     - `checkout.session.completed` - Activate subscription or add Job Search Pass credits
     - `customer.subscription.updated` - Handle plan changes (upgrades/downgrades)
     - `customer.subscription.deleted` - Downgrade to free tier
     - `invoice.payment_failed` - Update status, log failure
     - `invoice.paid` - Reset monthly CV usage
   - All events logged to billing_events table
   - Returns 200 quickly to acknowledge receipt

5. **Customer Portal** (`app/api/stripe/portal/route.ts`)
   - POST endpoint for billing portal access
   - Creates Stripe billing portal session
   - Returns portal URL for subscription management

**Database Schema** (already exists: `supabase/migrations/007_billing_and_usage.sql`)
- `user_billing` table with subscription fields
- `billing_events` table for audit trail
- `usage_logs` table for CV generation tracking
- Helper functions: check_can_generate_cv, get_user_usage, increment_cv_usage

**Environment Variables Required:**
```
STRIPE_SECRET_KEY=sk_...
STRIPE_PUBLISHABLE_KEY=pk_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_PRO_MONTHLY=price_...
STRIPE_PRICE_PRO_YEARLY=price_...
STRIPE_PRICE_POWER_MONTHLY=price_...
STRIPE_PRICE_POWER_YEARLY=price_...
STRIPE_PRICE_JOB_SEARCH_PASS=price_...
```

**Pricing Tiers:**
- Free: 3 CVs/month, basic features
- Pro ($9/mo or $69/yr): 30 CVs/month, Gmail sync, research chat
- Power ($19/mo or $149/yr): Unlimited CVs, cover letters, interview prep
- Job Search Pass ($39 one-time): 50 CVs + 6 months Pro features

**Next Steps:**
1. Create Stripe products/prices in dashboard
2. Set up webhook endpoint in Stripe dashboard
3. Test checkout flow end-to-end
4. Build pricing page UI

---

## Session: 2026-01-02 (Landing Page Design System)

### Completed: Visual Design System for Landing Page & Onboarding

Created comprehensive design system inspired by Attio, Linear, Claude, and Intercom.

**Design System Documentation:**
- `docs/DESIGN_SYSTEM_LANDING.md` - Full visual system specification
  - Color palette (Primary Violet, Secondary Coral, Warm Slate neutrals)
  - Typography scale (Display through caption sizes)
  - Spacing system based on 4px grid
  - Component styles (buttons, cards, inputs, badges)
  - Animation principles and micro-interactions
  - Hero section layouts (light/dark variants)
  - Onboarding flow design patterns
  - Accessibility guidelines

**Implementation Files:**
- `app/styles/landing.css` - Ready-to-use CSS classes
  - Hero section styles
  - Navigation component
  - Feature cards
  - Testimonial cards
  - Stats section
  - CTA section
  - Onboarding UI
  - Scroll reveal animations
  - Floating elements/badges

**React Components:**
- `app/components/landing/LandingComponents.tsx` - Reusable components
  - LandingNav (fixed nav with scroll effect)
  - Hero (light/dark variants)
  - Section + SectionHeader
  - FeatureCard (with reveal animation)
  - StatsGrid
  - TestimonialCard
  - CTASection
  - Badge
  - Button (primary/secondary/ghost)
  - LandingFooter
  - useRevealOnScroll hook

**Brand Personality Defined:**
- Professional but not corporate
- Modern and clean
- Trustworthy (secure feeling)
- Slightly playful (reduces job search stress)

**Key Design Decisions:**
- Primary color: Violet #8B5CF6 (Linear-inspired)
- Accent: Coral #F43F5E (for celebrations/playfulness)
- Dark mode: Deep navy #09090B with purple glow
- Border radius: 8-16px (modern, approachable)
- Shadows: Subtle with border fallback (Linear-style)
- Animations: 150-200ms for interactions, 300-500ms for reveals

---

## Session: 2026-01-02 (CV Library + CV Tailor)

### Completed: CV Library Feature

**CV Library (cards-based view on /cv page):**
- Grid layout showing all CVs (master + tailored)
- Master CV card with orange gradient styling
- Tailored CV cards show company, role, date
- Filter tabs: All / Master / Tailored
- Click card to preview PDF in modal
- Delete tailored CVs with confirmation
- Empty states for no CVs

**Files Created:**
- `app/components/CVCard.tsx` - Tailored CV card
- `app/components/MasterCVCard.tsx` - Master CV card with special styling
- `app/components/CVPreviewModal.tsx` - PDF preview modal
- `app/components/CVGrid.tsx` - Grid with filtering and state management
- `app/api/cvs/route.ts` - GET all CVs endpoint
- `app/api/cvs/[id]/route.ts` - DELETE tailored CV endpoint
- `lib/types.ts` - Added CV type
- `docs/FEATURE_CV_LIBRARY.md` - Feature specification

**Updated:**
- `app/cv/page.tsx` - Replaced text editor with CV Library grid

### Previous Work Today: CV Tailor Feature

**CV Tailor (generate tailored CVs per application):**
- Takes master CV + job URL
- Fetches JD from URL
- Generates tailored 1-page CV via Claude Sonnet
- Converts to PDF via Puppeteer
- Stores in Supabase Storage
- UI in CardDetailModal Details tab

**Files Created:**
- `lib/cv-tailor.ts` - AI CV generation logic
- `lib/pdf-generator.ts` - Puppeteer PDF generation
- `app/api/applications/[id]/tailored-cv/route.ts` - GET/POST endpoints
- `app/components/TailoredCVSection.tsx` - UI component
- `supabase/migrations/006_tailored_cv.sql` - Added tailored_cv columns
- `docs/FEATURE_CV_TAILOR.md` - Feature specification

### Auto-Generate CV on Save (c87c50b)

- CVs auto-generate in background when jobs saved with URL
- CV badge on job cards in Kanban board
- Click badge to view/download tailored CV PDF

**Files:**
- `lib/cv-auto-generate.ts` - Background CV generation
- Updated `app/api/applications/route.ts` - Trigger on POST
- Updated `app/api/applications/[id]/route.ts` - Trigger on PATCH
- Updated `app/components/ApplicationCard.tsx` - CV badge

### Next Steps
1. Test auto-generation flow end-to-end

---

## Session: 2026-01-02 (Research Chat Feature)

### Completed: Major Refactor + Research Chat

**Phase 1 - Cleanup:**
- Removed Prep tab from CardDetailModal (~300 lines)
- Removed EmailSidePanel from KanbanBoard (duplicate with Timeline)
- Deleted 4 unused files, net -313 lines of code

**Phase 2 - Research Chat Feature:**
- New interactive chat interface replacing static research view
- Components: ResearchChat, ChatMessage, SuggestedQuestions
- API routes for chat messaging and history
- Perplexity API integration for web search
- Claude Sonnet for conversational responses
- Chat history persisted in database
- 4 initial suggestions, 3-4 follow-up suggestions per response

**Files Created:**
- `app/components/ResearchChat.tsx`
- `app/components/ChatMessage.tsx`
- `app/components/SuggestedQuestions.tsx`
- `app/api/research/chat/route.ts`
- `app/api/research/chat/[applicationId]/route.ts`
- `lib/perplexity.ts`
- `lib/research-chat.types.ts`
- `supabase/migrations/005_research_chats.sql`
- `docs/FEATURE_RESEARCH_CHAT.md`

**To Use:**
1. Run migration: `005_research_chats.sql`
2. Add `PERPLEXITY_API_KEY` to `.env.local`
3. Open application → Research tab → Ask questions

**Commit:** e9c33f9

---

## Session: 2026-01-01 (Left Nav, CV Module, Skills Matcher)

### Completed: 3 Major Features in 4 Sprints

Built complete features using expert agent team:

**Sprint 1: Left Side Navigation**
- `app/components/SideNav.tsx` - Collapsible sidebar with 4 nav items
- `app/components/NavItem.tsx` - Reusable nav item component
- `app/components/AppLayout.tsx` - Layout wrapper
- Modified `app/layout.tsx` to use AppLayout
- Keyboard shortcuts: G J, G C, G R, G S
- localStorage persistence for collapse state
- Auto-collapse on mobile (<768px)

**Sprint 2: CV Module**
- `app/cv/page.tsx` - CV management page
- `app/api/cv/route.ts` - GET/POST endpoints
- `app/api/cv/[id]/route.ts` - PUT/DELETE endpoints
- `lib/cv.types.ts` - TypeScript interfaces
- `supabase/migrations/004_cv_table.sql` - Database migration
- Features: text editor, character count, save/delete with confirmation

**Sprint 3: Skills Matcher**
- `app/api/applications/[id]/analyze-match/route.ts` - AI analysis endpoint
- `lib/skills-matcher.types.ts` - TypeScript interfaces
- Updated `app/components/CardDetailModal.tsx` with Skills Matcher UI
- Uses OpenAI GPT-4o-mini for JD vs CV analysis
- Shows matched skills (green), gaps (amber), talking points

**Sprint 4: Playwright Tests**
- `tests/e2e/features.spec.ts` - E2E tests for all new features

**Documentation:**
- Updated `roadmap.md` with changelog
- PRD-001, PRD-002, PRD-003 marked as "Shipped"

**Commit:** 2410f7d - Pushed to GitHub

---

## Session: 2025-12-31 (Chrome Extension)

### Completed: Chrome Extension (Phase 3)

Built complete Chrome Extension with expert team:

**Files Created:**
- `extension/manifest.json` - Manifest V3 config
- `extension/popup.html` - Save job form UI
- `extension/popup.css` - Modern styling with warning states
- `extension/popup.js` - Form logic + duplicate checking
- `extension/content.js` - Job data extraction for LinkedIn, Indeed, Glassdoor, Ashby
- `extension/background.js` - Service worker for badge updates
- `app/api/extension/save/route.ts` - POST endpoint to save jobs
- `app/api/extension/check-duplicate/route.ts` - GET endpoint to check duplicates

**Features:**
1. Auto-extracts company, role, location from job posting pages
2. Duplicate detection before saving (warns if already exists)
3. Saves to "Saved" column in tracker
4. Works on LinkedIn, Indeed, Glassdoor, Ashby job pages
5. Clean popup UI matching main app styling

**To Install Extension:**
1. Open Chrome → `chrome://extensions/`
2. Enable "Developer mode" (top right)
3. Click "Load unpacked"
4. Select the `extension/` folder

**Icons Needed:**
Create PNG icons (16x16, 48x48, 128x128) or Chrome will use placeholders.

---

## Previous Session: Research Feature Fix

Fixed research API to use REAL data from job postings:
- Changed from GET to POST method
- Added job URL fetching + content extraction
- Added email context fetching
- Handles JavaScript-rendered pages (meta tags, JSON-LD)
- Correctly extracts voize.de domain, Berlin HQ, Series A funding

---

## Session: 2026-01-02 (Onboarding Feature Specification)

### Completed: FEATURE_ONBOARDING_CV_BOOSTER.md

Created comprehensive feature specification for the onboarding flow with CV Booster:

**Key Decisions:**
- 7-step flow: OAuth → CV Input → AI Questions → Review → Job URL → AHA → Dashboard
- CV input: Text paste + PDF upload (no LinkedIn API due to restrictions)
- AI Questions: One at a time (wizard style), 3-4 for existing CV, 5-7 from scratch
- All questions skippable - generate anyway with warning
- AHA moment: Seeing tailored CV generated in <30 seconds

**Files to Create:**
- `app/(onboarding)/*` - New route group with 5 pages
- `app/components/onboarding/*` - 10 new components
- `app/api/onboarding/*` - 3 new API routes
- `lib/cv-analyzer.ts` - CV gap analysis logic
- `lib/cv-enhancer.ts` - CV enhancement logic
- `supabase/migrations/007_onboarding.sql` - Schema changes

**Success Metrics:**
- Onboarding completion: 75%+
- Time to complete: <2 minutes
- Day-7 retention: 40%+

---

## Session: 2026-01-02 (Credits System)

### Completed: Full Credits-Based Billing System

Implemented complete credits system with bundle purchases (Marc Lou pricing philosophy).

**Database Migration:**
- `supabase/migrations/008_credits_model.sql`
  - Added `cv_credits`, `total_credits_purchased`, `last_free_credit_reset` to user_billing
  - Created `credit_purchases` table for purchase history
  - Created `credit_usage_log` table for audit trail
  - Helper functions: `add_credits`, `use_credit`, `get_credit_balance`, `reset_free_credits`
  - Monthly free credits reset (ensures minimum of 3, doesn't reduce existing)

**Credit Bundles:**
- Starter: 10 credits @ $9 ($0.90/credit)
- Job Seeker: 30 credits @ $19 ($0.63/credit) - 30% off, "Popular"
- Power Search: 100 credits @ $39 ($0.39/credit) - 57% off

**Backend Files:**
- `lib/credits.ts` - Credit bundle config and management functions
- `lib/stripe-prices.ts` - Simplified to credit bundles only (removed subscriptions)
- `app/api/stripe/webhooks/route.ts` - Simplified to handle checkout.session.completed only
- `app/api/credits/route.ts` - GET endpoint for credit balance
- `app/api/credits/use/route.ts` - POST endpoint to consume 1 credit

**Frontend Components:**
- `app/components/billing/CreditBalance.tsx` - Shows credits in sidebar
  - 3 variants: sidebar, header, compact
  - Color coding: green (>=3), amber (1-2), red (0)
  - Auto-refresh on window focus
- `app/components/billing/BuyCreditsModal.tsx` - Purchase modal
  - 3 bundle cards, highlights "Job Seeker" as popular
  - Initiates Stripe checkout
- `app/components/billing/LowCreditsWarning.tsx` - Warning when credits <= 3
- `app/components/SideNav.tsx` - Credits display integrated into sidebar

**Playwright Tests:**
- `tests/e2e/credits.spec.ts` - E2E tests for credits display, modal, checkout flow

**To Activate:**
1. Run migrations in Supabase SQL editor:
   - `supabase/migrations/006_tailored_cv.sql` (for tailored CV columns)
   - `supabase/migrations/008_credits_model.sql` (for credits system)
2. Create Stripe products for 3 bundles in Stripe Dashboard:
   - Starter: $9 one-time payment (10 credits)
   - Job Seeker: $19 one-time payment (30 credits)
   - Power Search: $39 one-time payment (100 credits)
3. Add price IDs to `.env.local`:
   ```
   STRIPE_PRICE_STARTER=price_...
   STRIPE_PRICE_JOB_SEEKER=price_...
   STRIPE_PRICE_POWER=price_...
   ```

---

## Next Steps

1. Create Stripe products/prices in dashboard and get real price IDs
2. Set up webhook endpoint in Stripe: `https://yourapp.com/api/stripe/webhooks`
3. Build pricing page UI using design system
4. Build actual landing page using the design system
5. Implement onboarding flow (see `docs/FEATURE_ONBOARDING_CV_BOOSTER.md`)
6. Add icons to extension (optional - works without)
7. Deploy to production and update extension's API_BASE_URL
